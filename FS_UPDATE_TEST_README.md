# 文件系统更新功能测试指南

## 问题概述
之前版本的文件系统更新功能存在问题，导致上传失败或更新不生效。主要原因是：
1. EEPROM标志处理不正确
2. 文件系统更新逻辑不完整
3. 缺少配置文件备份和恢复机制

## 修复内容
1. 修正了EEPROM标志的读取和设置逻辑（使用值3而不是1）
2. 完善了文件系统更新流程，包括配置文件的备份和恢复
3. 简化了不必要的文件系统状态检查
4. 增加了适当的文件大小验证范围

## 测试步骤

### 1. 准备工作
- 确保设备已刷入修复后的固件
- 确保设备处于可访问状态（STA模式或AP模式）

### 2. 使用Web界面测试
1. 连接到设备的WiFi网络
2. 打开浏览器访问设备IP地址
3. 进入文件系统更新页面
4. 选择一个有效的文件系统镜像文件（.bin格式）
5. 点击上传按钮
6. 观察上传进度和结果

### 3. 使用Python脚本测试
1. 安装Python依赖：
   ```
   pip install requests
   ```

2. 修改测试脚本中的设备IP地址：
   ```python
   DEVICE_IP = "your_device_ip_address"
   ```

3. 运行测试脚本：
   ```
   python test_fs_update.py
   ```

### 4. 预期结果
- 文件应成功上传到设备
- 设备应自动重启以应用更新
- 重启后设备应正常运行
- 配置文件应得到保留

## 故障排除

### 如果上传仍然失败
1. 检查串口日志以获取详细错误信息
2. 确认文件大小在合理范围内（1KB-3MB）
3. 确认文件格式正确

### 如果设备无法重启
1. 检查EEPROM标志设置是否正确
2. 查看串口输出确认更新流程是否正常执行

## 技术细节

### EEPROM标志说明
- 地址500: 更新标志（3表示文件系统更新）
- 地址501-504: 文件大小（32位值，按字节存储）
- 地址505: 配置恢复标志（1表示需要恢复配置）

### 文件处理流程
1. 上传文件保存为/littlefs.bin
2. 设置EEPROM更新标志
3. 设备重启后检测标志并应用更新
4. 备份重要配置文件（.bak扩展名）
5. 应用文件系统更新
6. 恢复配置文件
7. 清除更新标志
8. 设备再次重启完成更新