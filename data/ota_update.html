<!DOCTYPE html>
<html>
<head>
    <title>OTAå‡çº§</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tab {
            display: none;
        }
        .active {
            display: block;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            border-radius: 10px;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OTAå‡çº§</h1>
        <div class="status-info">
            <strong>è®¾å¤‡çŠ¶æ€:</strong><br>
            â€¢ å›ºä»¶ç‰ˆæœ¬: 0.9.1<br>
            â€¢ è¿è¡Œæ—¶é—´: 0 åˆ†é’Ÿ<br>
            â€¢ å¯ç”¨å†…å­˜: 0 KB
        </div>

        <!-- ä¸»æ ‡ç­¾é¡µ -->
        <div class="tab active" id="mainTab">
            <h3>é€‰æ‹©å‡çº§ç±»å‹</h3>
            <button onclick="showTab('firmwareTab')">ğŸ”§ å›ºä»¶å‡çº§</button>
            <button onclick="showTab('fsTab')">ğŸ’¾ æ–‡ä»¶ç³»ç»Ÿæ›´æ–°</button>
            <button onclick="showTab('fileTab')">ğŸ“„ å•ä¸ªæ–‡ä»¶ä¸Šä¼ </button>
        </div>

        <!-- å›ºä»¶å‡çº§æ ‡ç­¾é¡µ -->
        <div class="tab" id="firmwareTab">
            <h3>å›ºä»¶å‡çº§</h3>
            <p>é€‰æ‹©.binæ–‡ä»¶å‡çº§å›ºä»¶</p>
            <form action="/firmware_update" method="post" enctype="multipart/form-data" onsubmit="return uploadFirmware(this)">
                <input type="file" name="firmware" accept=".bin" required><br>
                <button type="submit">å¼€å§‹å‡çº§</button>
            </form>
            <div class="progress"><div class="progress-bar" id="firmwareProgress"></div></div>
            <p id="firmwareStatus"></p>
            <button class="btn-secondary" onclick="showTab('mainTab')">è¿”å›</button>
        </div>

        <!-- æ–‡ä»¶ç³»ç»Ÿæ›´æ–°æ ‡ç­¾é¡µ -->
        <div class="tab" id="fsTab">
            <h3>æ–‡ä»¶ç³»ç»Ÿæ›´æ–°</h3>
            <p>é€‰æ‹©.binæ–‡ä»¶æ›´æ–°æ–‡ä»¶ç³»ç»Ÿ</p>
            <form action="/filesystem_update" method="post" enctype="multipart/form-data" onsubmit="return uploadFilesystem(this)">
                <input type="file" name="filesystem" accept=".bin" required><br>
                <button type="submit">å¼€å§‹æ›´æ–°</button>
            </form>
            <div class="progress"><div class="progress-bar" id="fsProgress"></div></div>
            <p id="fsStatus"></p>
            <button class="btn-secondary" onclick="showTab('mainTab')">è¿”å›</button>
        </div>

        <!-- å•ä¸ªæ–‡ä»¶ä¸Šä¼ æ ‡ç­¾é¡µ -->
        <div class="tab" id="fileTab">
            <h3>å•ä¸ªæ–‡ä»¶ä¸Šä¼ </h3>
            <p>é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶</p>
            <form action="/upload_file" method="post" enctype="multipart/form-data" onsubmit="return uploadSingleFile(this)">
                <input type="file" name="file" accept=".html,.js,.css,.txt" required onchange="updateTargetPath(this)">
                <div style="margin:10px 0;">
                    <label>ç›®æ ‡è·¯å¾„ï¼š</label><br>
                    <input type="text" name="target_path" id="targetPath" placeholder="ç³»ç»Ÿå°†è‡ªåŠ¨æ¨æ–­è·¯å¾„" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" readonly>
                </div>
                <button type="submit">ä¸Šä¼ æ–‡ä»¶</button>
            </form>
            <div class="progress"><div class="progress-bar" id="fileProgress"></div></div>
            <p id="fileStatus"></p>
            <button class="btn-secondary" onclick="showTab('mainTab')">è¿”å›</button>
        </div>
    </div>

    <script>
        function showTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function updateTargetPath(input) {
            var file = input.files[0];
            if (file) {
                var filename = file.name.toLowerCase();
                var targetPath = '/';
                if (filename.endsWith('.html')) {
                    targetPath = '/index.html';
                } else if (filename.endsWith('.js')) {
                    targetPath = '/lang.js';
                } else if (filename.endsWith('.css')) {
                    targetPath = '/title-styles.css';
                }
                document.getElementById('targetPath').value = targetPath;
            }
        }

        function uploadFirmware(f) {
            var x = new XMLHttpRequest();
            x.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    var p = Math.round(e.loaded / e.total * 100);
                    document.getElementById('firmwareProgress').style.width = p + '%';
                    document.getElementById('firmwareStatus').innerHTML = 'è¿›åº¦:' + p + '%';
                }
            };
            x.onload = function() {
                if (x.status == 200) {
                    var r = JSON.parse(x.responseText);
                    document.getElementById('firmwareStatus').innerHTML = r.status == 'success' ? 'æˆåŠŸï¼Œé‡å¯ä¸­...' : 'å¤±è´¥:' + r.message;
                } else {
                    document.getElementById('firmwareStatus').innerHTML = 'å¤±è´¥';
                }
            };
            x.open('POST', '/firmware_update');
            x.send(new FormData(f));
            return false;
        }

        function uploadFilesystem(f) {
            var x = new XMLHttpRequest();
            x.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    var p = Math.round(e.loaded / e.total * 100);
                    document.getElementById('fsProgress').style.width = p + '%';
                    document.getElementById('fsStatus').innerHTML = 'è¿›åº¦:' + p + '%';
                }
            };
            x.onload = function() {
                if (x.status == 200) {
                    var r = JSON.parse(x.responseText);
                    document.getElementById('fsStatus').innerHTML = r.status == 'success' ? 'æˆåŠŸï¼Œé‡å¯ä¸­...' : 'å¤±è´¥:' + r.message;
                } else {
                    document.getElementById('fsStatus').innerHTML = 'å¤±è´¥';
                }
            };
            x.open('POST', '/filesystem_update');
            x.send(new FormData(f));
            return false;
        }

        function uploadSingleFile(f) {
            var t = f.target_path.value;
            if (!t) {
                document.getElementById('fileStatus').innerHTML = 'è¯·é€‰æ‹©ç›®æ ‡è·¯å¾„';
                return false;
            }
            document.getElementById('fileStatus').innerHTML = 'ä¸Šä¼ ä¸­...';
            var x = new XMLHttpRequest();
            x.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    var p = Math.round(e.loaded / e.total * 100);
                    document.getElementById('fileProgress').style.width = p + '%';
                    document.getElementById('fileStatus').innerHTML = 'è¿›åº¦:' + p + '%';
                }
            };
            x.onload = function() {
                if (x.status == 200) {
                    try {
                        var r = JSON.parse(x.responseText);
                        document.getElementById('fileStatus').innerHTML = r.status == 'success' ? 'æˆåŠŸ' : 'å¤±è´¥:' + r.message;
                        document.getElementById('fileProgress').style.width = '0%';
                    } catch (e) {
                        document.getElementById('fileStatus').innerHTML = 'è§£æé”™è¯¯';
                    }
                } else {
                    document.getElementById('fileStatus').innerHTML = 'HTTPé”™è¯¯';
                }
                document.getElementById('fileProgress').style.width = '0%';
            };
            x.onerror = function() {
                document.getElementById('fileStatus').innerHTML = 'ç½‘ç»œé”™è¯¯';
                document.getElementById('fileProgress').style.width = '0%';
            };
            x.open('POST', '/upload_file');
            x.send(new FormData(f));
            return false;
        }
    </script>
</body>
</html>