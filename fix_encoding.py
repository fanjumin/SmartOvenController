import chardet
import os

def fix_encoding_issues():
    filepath = 'data/index.html'
    backup_path = 'data/index.html.backup'
    
    if os.path.exists(filepath):
        # Create backup
        with open(filepath, 'rb') as f:
            content_bytes = f.read()
        
        # Save backup
        with open(backup_path, 'wb') as f:
            f.write(content_bytes)
        
        # Detect encoding
        detected = chardet.detect(content_bytes)
        print(f"Detected encoding: {detected}")
        
        # Try to read with UTF-8 first
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                content = f.read()
        except UnicodeDecodeError:
            # If UTF-8 fails, try with detected encoding
            with open(filepath, 'r', encoding=detected['encoding']) as f:
                content = f.read()
        
        # Fix common乱码 issues
        # Replace common乱码 patterns with proper Chinese characters
        fixes = {
            'æ˜¾ç¤º': '显示',
            'è®¾ç½®': '设置',
            'æ‰€æœ‰è®¾ç½®å°†è¢«æ¸…é™¤': '所有设置将被清除',
            'è®¾å¤‡å°†é‡å¯å¹¶æ¢å¤å‡ºå‚¿çŠ¶æ€': '设备将重启并恢复出厂状态',
            'ç§’åŽè‡ªåŠ¨åˆ·æ–°é¡µé¢': '秒后自动刷新页面',
            'æ›´æ–°å€¼': '更新值',
            'æ‰‹åŠ¨è°ƒæ•´': '手动调整',
            'è°ƒæ•´': '调整',
            'å¼€å§‹åŠ çƒ­åˆ°': '开始加热到',
            'æŒç»­': '持续',
            'åˆ†é’Ÿ': '分钟',
            'æ¨¡å¼': '模式',
            'è¯·è¾“å…¥å½“å‰å¯†ç ': '请输入当前密码',
            'è¯·è¾“å…¥æ–°å¯†ç ': '请输入新密码',
            'è¯·ç¡®è®¤æ–°å¯†ç ': '请确认新密码',
            'æ–°å¯†ç è¾“å…¥ä¸ä¸€è‡´': '新密码输入不一致',
            'å·²è¿žæŽ¥': '已连接',
            'å¯†ç ä¿®æ”¹æˆåŠŸ': '密码修改成功',
            'å¯†ç ä¿®æ”¹å¤±è´¥': '密码修改失败',
            'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¸©åº¦å€¼': '请输入有效的温度值',
            'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´å€¼': '请输入有效的时间值',
            'åŠ çƒ­å™¨å·¥ä½œä¸­': '加热器工作中',
            'åŠ çƒ­å™¨å·²åœæ­¢': '加热器已停止',
            'è¿žæŽ¥å¤±è´¥': '连接失败',
            'è®¾å¤‡ä¸åœ¨çº¿': '设备不在线',
            'è¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥': '请检查网络连接',
            'è¯·ç¨åŽé‡è¯•': '请稍后重试',
            'è¯·å…ˆè¿žæŽ¥è®¾å¤‡': '请先连接设备',
            'è¿žæŽ¥è¶…æ—¶': '连接超时',
            'è®¾å¤‡æœªå“åº”': '设备未响应',
            'è¯·æ£€æŸ¥è®¾å¤‡çŠ¶æ€': '请检查设备状态',
            'è¯·é‡æ–°è¿žæŽ¥': '请重新连接',
            'è¿žæŽ¥è¢«æ–­': '连接被断开',
            'è®¾å¤‡å·²ç¦»çº¿': '设备已离线',
            'è¯·æ£€æŸ¥WiFiè¿žæŽ¥': '请检查WiFi连接',
            'WiFiå¯†ç é”™è¯¯': 'WiFi密码错误',
            'WiFiåç§°æœªæ‰¾åˆ°': 'WiFi名称未找到',
            'è¯·é‡æ–°é…ç½®WiFi': '请重新配置WiFi',
            'è®¾å¤‡å·²è¿žæŽ¥': '设备已连接',
            'è¿žæŽ¥å·²å»ºç«‹': '连接已建立',
            'è¯·ç­‰å¾…è®¾å¤‡å“åº”': '请等待设备响应',
            'è®¾å¤‡å¿™ç¢Œä¸­': '设备忙碌中',
            'è¯·ç¨å€™å†è¯•': '请稍后再试',
            'è®¾å¤‡å‡†å¤‡å°±ç»ª': '设备准备就绪',
            'å¯ä»¥å¼€å§‹æ“ä½œ': '可以开始操作',
            'è®¾å¤‡å·¥ä½œä¸­': '设备工作中',
            'è¯·ç­‰å¾…æ“ä½œå®Œæˆ': '请等待操作完成',
            'æ“ä½œå·²å®Œæˆ': '操作已完成',
            'è®¾å¤‡å°†åœæ­¢å·¥ä½œ': '设备将停止工作',
            'è¯·ç¡®è®¤æ“ä½œ': '请确认操作',
            'æ“ä½œè¢«å–æ¶ˆ': '操作被取消',
            'è¯·é‡æ–°å°è¯•': '请重新尝试',
            'è®¾å¤‡å‡ºçŽ°é”™è¯¯': '设备出现错误',
            'è¯·è”ç³»æŠ€æœ¯æ”¯æŒ': '请联系技术支持',
            'è®¾å¤‡éœ€è¦ç»´æŠ¤': '设备需要维护',
            'è¯·å®šæœŸæ£€æŸ¥': '请定期检查',
            'è®¾å¤‡éœ€è¦æ›´æ–°': '设备需要更新',
            'è¯·å®‰è£…æœ€æ–°å›ºä»¶': '请安装最新固件',
            'è®¾å¤‡å®‰å…¨æ€§æ£€æŸ¥': '设备安全性检查',
            'è¯·ä¿è¯è®¾å¤‡å®‰å…¨': '请保证设备安全',
            'è®¾å¤‡æ­£åœ¨å‡çº§': '设备正在升级',
            'è¯·å‹¿æ–­å¼€ç”µæº': '请勿断开电源',
            'å‡çº§å®Œæˆ': '升级完成',
            'è®¾å¤‡å°†é‡å¯': '设备将重启',
            'è¯·ç­‰å¾…é‡å¯': '请等待重启',
            'é‡å¯å®Œæˆ': '重启完成',
            'è®¾å¤‡å·²æ¢å¤': '设备已恢复',
            'å¯ä»¥ç»§ç»­ä½¿ç”¨': '可以继续使用',
            'è®¾å¤‡å‡ºåŽ‚è®¾ç½®': '设备出厂设置',
            'æ‰€æœ‰ä¸ªäººä¿¡æ¯å°†è¢«åˆ é™¤': '所有个人信息将被删除',
            'è¯·è°¨æ…Žæ“ä½œ': '请谨慎操作',
            'æ“ä½œä¸å¯é€†': '操作不可逆',
            'è¯·å¤‡ä»½é‡è¦æ•°æ®': '请备份重要数据',
            'è®¾å¤‡å°†æ¢å¤é»˜è®¤è®¾ç½®': '设备将恢复默认设置',
            'è¯·ç¡®è®¤æ¢å¤å‡ºå‚¿è®¾ç½®': '请确认恢复出厂设置',
            'è®¾å¤‡å°†æ¸…é™¤æ‰€æœ‰æ•°æ®': '设备将清除所有数据',
            'è¯·ç¡®è®¤æ¸…é™¤æ•°æ®': '请确认清除数据',
            'æ•°æ®æ¸…é™¤å®Œæˆ': '数据清除完成',
            'è®¾å¤‡å°†æ ¼å¼åŒ–': '设备将格式化',
            'è¯·ç¡®è®¤æ ¼å¼åŒ–': '请确认格式化',
            'æ ¼å¼åŒ–å®Œæˆ': '格式化完成',
            'è®¾å¤‡å°†æ¢å¤ç³»ç»Ÿ': '设备将恢复系统',
            'è¯·ç¡®è®¤æ¢å¤ç³»ç»Ÿ': '请确认恢复系统',
            'ç³»ç»Ÿæ¢å¤å®Œæˆ': '系统恢复完成',
            'è®¾å¤‡å°†è¿›è¡Œè‡ªæ£€': '设备将进行自检',
            'è¯·ç­‰å¾…è‡ªæ£€å®Œæˆ': '请等待自检完成',
            'è‡ªæ£€å®Œæˆ': '自检完成',
            'è®¾å¤‡çŠ¶æ€æ­£å¸¸': '设备状态正常',
            'è®¾å¤‡å¯ä»¥ä½¿ç”¨': '设备可以使用',
            'è®¾å¤‡éœ€è¦é…ç½®': '设备需要配置',
            'è¯·è¿›è¡Œåˆå§‹é…ç½®': '请进行初始配置',
            'è®¾å¤‡é…ç½®å®Œæˆ': '设备配置完成',
            'è®¾å¤‡å°†åº”ç”¨æ–°é…ç½®': '设备将应用新配置',
            'è¯·ç­‰å¾…é…ç½®åº”ç”¨': '请等待配置应用',
            'é…ç½®åº”ç”¨å®Œæˆ': '配置应用完成',
            'è®¾å¤‡å°†ä¿å­˜é…ç½®': '设备将保存配置',
            'è¯·ç­‰å¾…é…ç½®ä¿å­˜': '请等待配置保存',
            'é…ç½®ä¿å­˜å®Œæˆ': '配置保存完成',
            'è®¾å¤‡å°†åŠ è½½é…ç½®': '设备将加载配置',
            'è¯·ç­‰å¾…é…ç½®åŠ è½½': '请等待配置加载',
            'é…ç½®åŠ è½½å®Œæˆ': '配置加载完成',
            'è®¾å¤‡å°†éªŒè¯é…ç½®': '设备将验证配置',
            'è¯·ç­‰å¾…é…ç½®éªŒè¯': '请等待配置验证',
            'é…ç½®éªŒè¯å®Œæˆ': '配置验证完成',
            'è®¾å¤‡é…ç½®æœ‰æ•ˆ': '设备配置有效',
            'è®¾å¤‡å¯ä»¥è¿è¡Œ': '设备可以运行',
            'è®¾å¤‡é…ç½®æ— æ•ˆ': '设备配置无效',
            'è¯·é‡æ–°é…ç½®': '请重新配置',
            'è®¾å¤‡é…ç½®å¼‚å¸¸': '设备配置异常',
            'è¯·æ£€æŸ¥é…ç½®å†…å®¹': '请检查配置内容',
            'è®¾å¤‡é…ç½®ä¸å®Œæ•´': '设备配置不完整',
            'è¯·è¡¥å…¨é…ç½®': '请补全配置',
            'è®¾å¤‡é…ç½®å†²çª': '设备配置冲突',
            'è¯·è§£å†³å†²çª': '请解决冲突',
            'è®¾å¤‡é…ç½®è¿‡æœŸ': '设备配置过期',
            'è¯·æ›´æ–°é…ç½®': '请更新配置',
            'è®¾å¤‡é…ç½®å°†è¢«é”å®š': '设备配置将被锁定',
            'è¯·ç¡®è®¤é”å®šé…ç½®': '请确认锁定配置',
            'è®¾å¤‡é…ç½®å·²é”å®š': '设备配置已锁定',
            'æ— æ³•ä¿®æ”¹é…ç½®': '无法修改配置',
            'è®¾å¤‡é…ç½®å°†è¢«è§£é”': '设备配置将被解锁',
            'è¯·ç¡®è®¤è§£é”é…ç½®': '请确认解锁配置',
            'è®¾å¤‡é…ç½®å·²è§£é”': '设备配置已解锁',
            'å¯ä»¥ä¿®æ”¹é…ç½®': '可以修改配置',
            'è®¾å¤‡é…ç½®å°†è¢«å¤‡ä»½': '设备配置将被备份',
            'è¯·ç­‰å¾…é…ç½®å¤‡ä»½': '请等待配置备份',
            'é…ç½®å¤‡ä»½å®Œæˆ': '配置备份完成',
            'è®¾å¤‡é…ç½®å°†è¢«æ¢å¤': '设备配置将被恢复',
            'è¯·ç­‰å¾…é…ç½®æ¢å¤': '请等待配置恢复',
            'é…ç½®æ¢å¤å®Œæˆ': '配置恢复完成'
        }
        
        # Apply fixes
        original_content = content
        for garbled, fixed in fixes.items():
            content = content.replace(garbled, fixed)
        
        # Write fixed content back with UTF-8 encoding
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        
        print("File encoding fixed successfully!")
        print(f"Backup saved as: {backup_path}")

if __name__ == "__main__":
    fix_encoding_issues()