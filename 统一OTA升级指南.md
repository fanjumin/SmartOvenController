# 统一OTA升级指南

## 概述

为了解决传统OTA升级需要分别上传固件和HTML文件两次操作的不便，我们实现了统一的OTA升级功能。现在您可以通过一个界面同时升级固件和HTML文件，大大简化了设备维护流程。

## 新功能特性

### 1. 统一升级界面
- 访问 `/ota_update` 路径获得完整的升级界面
- 支持固件(.bin)和HTML文件同时上传
- 实时进度显示和状态反馈

### 2. 智能文件处理
- 自动识别文件类型（固件 vs HTML文件）
- 支持多文件批量上传
- 文件类型验证和安全检查

### 3. 集成式OTA服务器
- OTA升级功能集成到主Web服务器（端口80）
- 无需单独访问8080端口
- 统一的认证和访问控制

## 使用方法

### 1. 访问升级界面
1. 确保设备已启动并连接到网络
2. 在浏览器中访问：`http://设备IP/ota_update`
3. 您将看到统一的升级界面

### 2. 选择升级文件
- **固件升级**：选择编译生成的 `.bin` 文件
- **HTML文件升级**：选择需要更新的HTML/JS/CSS文件
- 支持同时选择多个文件

### 3. 开始升级
1. 点击"上传文件"按钮
2. 等待上传进度完成
3. 查看升级结果反馈
4. 设备将自动重启应用新固件/文件

## 技术实现

### 核心功能模块

#### 1. 统一升级界面 (`handleOTAUpdate`)
```cpp
// 提供包含选项卡的Web界面
// 支持固件和HTML文件上传
// 实时进度显示和AJAX上传
```

#### 2. 文件上传处理 (`handleFileUpload`)
```cpp
// 智能文件类型识别
// LittleFS文件系统操作
// 固件升级准备和验证
```

#### 3. 集成OTA服务器 (`setupOTA`)
```cpp
// 将OTA服务器绑定到主Web服务器
// 统一的端口80访问
// 自动处理固件升级流程
```

### 文件类型支持

| 文件类型 | 处理方式 | 目标位置 |
|---------|---------|---------|
| `.bin`  | 固件升级 | 设备闪存 |
| `.html` | 文件更新 | LittleFS |
| `.js`   | 文件更新 | LittleFS |
| `.css`  | 文件更新 | LittleFS |

## 优势对比

### 传统方式（两次操作）
1. 上传固件文件 (.bin)
2. 等待设备重启
3. 上传HTML文件
4. 再次等待设备重启

### 新统一方式（一次操作）
1. 同时选择固件和HTML文件
2. 一次性上传所有文件
3. 设备自动处理升级流程
4. 单次重启完成所有更新

## 测试验证

### 编译测试
```bash
# 在项目根目录执行
platformio run
```

### 功能测试
```bash
# 运行测试脚本
python test_ota_upgrade.py
```

### 实际设备测试
1. 烧录新固件到设备
2. 访问升级界面进行测试
3. 验证固件和文件上传功能

## 故障排除

### 常见问题

1. **升级界面无法访问**
   - 检查设备IP地址是否正确
   - 确认设备已启动Web服务器

2. **文件上传失败**
   - 检查文件大小是否超出限制
   - 验证文件类型是否支持
   - 检查LittleFS存储空间

3. **固件升级失败**
   - 确认.bin文件格式正确
   - 检查设备闪存空间
   - 验证网络连接稳定性

### 日志查看
升级过程中的详细日志可以通过串口监控查看：
```bash
platformio device monitor
```

## 版本历史

- **v0.7.0**：初始版本，支持基本OTA功能
- **v0.7.7**：实现统一OTA升级功能
  - 统一升级界面
  - 智能文件处理
  - 集成式OTA服务器

## 后续改进计划

1. **增量升级**：支持增量文件更新，减少数据传输量
2. **备份恢复**：升级前自动备份，支持版本回滚
3. **远程管理**：支持远程OTA升级管理
4. **安全增强**：添加数字签名验证和加密传输

## 总结

新的统一OTA升级功能显著简化了设备维护流程，将原本需要两次操作的过程合并为一次，提高了升级效率和用户体验。通过智能的文件处理和集成的升级界面，用户可以更方便地管理和更新设备固件及Web界面文件。